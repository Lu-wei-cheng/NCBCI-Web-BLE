<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>NCBCI Web BLE</title>
  </head>
  <style>

</style>
<body>
<button id="start-button">start</button>
<button id="stop-button">stop</button>
<div id="msg">msg</div>
<div id="container" style="height: 100%"></div>
	   
<script type="text/javascript" src="./js/echarts.min.js"></script>
<script>
var dom = document.getElementById("container");
		var myChart = echarts.init(dom);
		var app = {};
		option = null;
		function randomData() {
			now = new Date(+now + oneDay);
			value = value + Math.random() * 21 - 10;
			return {
				name: now.toString(),
				value: [
					[now.getFullYear(), now.getMonth() + 1, now.getDate()].join('/'),
					Math.round(value)
				]
			}
		}

		var data = [];
		var now = +new Date(1997, 9, 3);
		var oneDay = 24 * 3600 * 1000;
		var value = Math.random() * 1000;
		for (var i = 0; i < 1000; i++) {
			data.push(randomData());
		}

		option = {
			title: {
				text: '我是神'
			},
			tooltip: {
				trigger: 'axis',
				formatter: function (params) {
					params = params[0];
					var date = new Date(params.name);
					return date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear() + ' : ' + params.value[1];
				},
				axisPointer: {
					animation: false
				}
			},
			xAxis: {
				type: 'time',
				splitLine: {
					show: false
				}
			},
			yAxis: {
				type: 'value',
				boundaryGap: [0, '100%'],
				splitLine: {
					show: false
				}
			},
			series: [{
				name: '模拟数据',
				type: 'line',
				showSymbol: false,
				hoverAnimation: false,
				data: data
			}]
		};

		setInterval(function () {

			for (var i = 0; i < 5; i++) {
				data.shift();
				data.push(randomData());
			}

			myChart.setOption({
				series: [{
					data: data
				}]
			});
		}, 1000);;
		if (option && typeof option === "object") {
			myChart.setOption(option, true);
		}
		
// 6e400003-b5a3-f393-e0a9-e50e24dcca9e
// Step 1: Scan for a device with 0xffe5 service
<!-- navigator.bluetooth.requestDevice({ -->
  <!-- filters: [{ services: [0xffe5] }] -->
<!-- }) -->
  <!-- .then(function(device) { -->
    <!-- // Step 2: Connect to it -->
    <!-- return device.gatt.connect(); -->
  <!-- }) -->
  <!-- .then(function(server) { -->
    <!-- // Step 3: Get the Service -->
    <!-- return server.getPrimaryService(0xffe5); -->
  <!-- }) -->
  <!-- .then(function(service) { -->
    <!-- // Step 4: get the Characteristic -->
    <!-- return service.getCharacteristic(0xffe9); -->
  <!-- }) -->
  <!-- .then(function(characteristic) { -->
    <!-- // Step 5: Write to the characteristic -->
    <!-- var data = new Uint8Array([0xbb, 0x25, 0x05, 0x44]); -->
    <!-- return characteristic.writeValue(data); -->
  <!-- }) -->
  <!-- .catch(function(error) { -->
     <!-- // And of course: error handling! -->
     <!-- console.error('Connection failed!', error); -->
  <!-- }); -->

const startbutton = document.querySelector('#start-button');
const stopbutton = document.querySelector('#stop-button');
const msg = document.getElementById('msg');

var myCharacteristic;

startbutton.addEventListener('click', function() {
	navigator.bluetooth.requestDevice({
		acceptAllDevices: true,
		optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e','6e400003-b5a3-f393-e0a9-e50e24dcca9e']
	}).then(device => {
		console.log('Got device:', device.name);
		console.log('id:', device.id);
		msg.innerHTML = 'Got device:' + device.name + ',' + 'id:'+ device.id;
	// Chromium 49 及以下版本请使用 connectGATT()
    // Chromium 50 之后版本请使用 gatt.connect()
	return device.gatt.connect();
	})
	.then(server => {
		console.log('Getting Service…');
		return server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
	})
	.then(service => {
		console.log('Getting Characteristic…');
		return service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');
	})
	.then(characteristic => {
    myCharacteristic = characteristic;
    return myCharacteristic.startNotifications().then(_ => {
      console.log('> Notifications started');
      myCharacteristic.addEventListener('characteristicvaluechanged',
          handleNotifications);
      });
    })
	.catch(exception => {
		console.log(exception);
	});
});

stopbutton.addEventListener('click', function() {
    onStopButtonClick();
});

function handleNotifications(event) {
  let value = event.target.value;
  let a = [];
  // Convert raw data bytes to hex values just for the sake of showing something.
  // In the "real" world, you'd use data.getUint8, data.getUint16 or even
  // TextDecoder to process raw data bytes.
  <!-- for (let i = 0; i < value.byteLength; i++) { -->
    <!-- a.push('0x' + ('00' + value.getUint8(i).toString(16)).slice(-2)); -->
  <!-- } -->
  //console.log('> ' + a.join(' '));
  
   <!-- for (let i = 0; i < value.byteLength; i++) { -->
    <!-- a.push('0x' + ('00' + value.getUint8(i).toString(16)).slice(-2)); -->
  <!-- } -->
  
  //console.log('getFloat32:' + value.getFloat32());
  //console.log(value.getFloat32());
  
  <!-- for (let i = 0 ; i < value.byteLength; i++){ -->
  <!-- console.log(value.getUint8(i).toString()); -->
  <!-- } -->
  let decoder = new TextDecoder('utf-8');
  
  console.log(decoder.decode(value));

}

function onStopButtonClick() {
  if (myCharacteristic) {
    myCharacteristic.stopNotifications()
    .then(_ => {
      console.log('> Notifications stopped');
      myCharacteristic.removeEventListener('characteristicvaluechanged',
          handleNotifications);
    })
    .catch(error => {
      console.log('Argh! ' + error);
    });
  }
}
</script>

</body>
</html>